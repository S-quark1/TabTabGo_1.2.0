var S=Object.defineProperty;var I=(a,s,t)=>s in a?S(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t;var m=(a,s,t)=>I(a,typeof s!="symbol"?s+"":s,t);class f{constructor(){m(this,"TASKS",[{taskId:"task_0101",targets:["Drafts","FIRST MESSAGE â€” - HELLO THIS IS THE FIRST MESSAGE","Close","Inbox"]},{taskId:"task_0102",targets:["Drafts","SECOND MESSAGE â€” - THIS IS THE SECOND MESSAGE","Close","Inbox"]},{taskId:"task_0103",targets:["Drafts","THIRD MESSAGE â€” - This is the third message","Close","Inbox"]},{taskId:"task_0104",targets:["Inbox","Hello there! â€” - Dear user, Please read this message. Thank you Best regards, BK","Not starred","Inbox","Starred","Hello there! â€” - Dear user, Please read this message. Thank you Best regards, BK","Starred","Inbox"]},{taskId:"task_0105",targets:["Compose","Discard draft â€ª(Ctrl-Shift-D)â€¬","Inbox"]},{taskId:"task_0201",targets:["Drafts","FIRST MESSAGE â€” - HELLO THIS IS THE FIRST MESSAGE","Close","Inbox"]},{taskId:"task_0202",targets:["Drafts","SECOND MESSAGE â€” - THIS IS THE SECOND MESSAGE","Close","Inbox"]},{taskId:"task_0203",targets:["Drafts","THIRD MESSAGE â€” - This is the third message","Close","Inbox"]},{taskId:"task_0204",targets:["Inbox","Hello there! â€” - Dear user, Please read this message. Thank you Best regards, BK","Not starred","Inbox","Starred","Hello there! â€” - Dear user, Please read this message. Thank you Best regards, BK","Starred","Inbox"]},{taskId:"task_0205",targets:["Compose","Discard draft â€ª(Ctrl-Shift-D)â€¬","Inbox"]}]);this.sessionData=null,this.sessionActive=!1,this.sessionTimer=null,this.currentTask=null,this.currentTaskIndex=0,this.lastInteractionTime=null,this.SESSION_DURATION_MS=900*1e3,this.waitingForTaskContinue=!1}async startSession(s,t,e){if(this.sessionActive)throw new Error("Session already active");const n=Date.now(),o=new Date(n).toISOString().split("T")[0],r=`P${s}`,l=`P${s}_S${t}`;return this.sessionData={participantId:r,mode:e,sessionId:l,sessionStartTs:n,sessionEndTs:null,sessionDuration:0,sessionDate:o,totalInteractions:0,totalManualClicks:0,totalTabTabGoClicks:0,totalTasks:this.TASKS.length,tasks:[],syncData:null},this.sessionActive=!0,this.currentTaskIndex=0,this.lastInteractionTime=n,await chrome.storage.local.set({currentSession:this.sessionData,sessionActive:!0}),this.sessionTimer=setTimeout(()=>{this.endSession()},this.SESSION_DURATION_MS),this.broadcastSessionState(),this.sessionData}async startTask(s=null){if(!this.sessionActive)throw new Error("No active session");s!==null&&(this.currentTaskIndex=s);const t=this.TASKS[this.currentTaskIndex];if(!t)throw new Error("Invalid task index");const e=Date.now();return this.currentTask={taskId:t.taskId,targets:t.targets||[],startTs:e,endTs:null,taskDuration:0,success:!1,interactions:[],clickSequence:[]},this.lastInteractionTime=e,this.waitingForTaskContinue=!1,await chrome.storage.local.set({currentSession:this.sessionData,currentTask:this.currentTask}),this.broadcastTaskInfo(),this.currentTask}normalizeText(s){return s?s.toLowerCase().replace(/[\n\r\t]+/g," ").replace(/\s+/g," ").replace(/[â€”â€“-]/g,"-").replace(/['']/g,"'").replace(/[""]/g,'"').replace(/[^\w\s'-]/g,"").trim():""}matchesTarget(s,t){if(!s||!t)return!1;const e=this.normalizeText(s),n=this.normalizeText(t);if(e===n||e.includes(n)||n.includes(e))return!0;const o=e.split(" ").filter(u=>u.length>0),r=n.split(" ").filter(u=>u.length>0);if(o.length===0||r.length===0)return!1;if(o.filter(u=>r.includes(u)).length/Math.min(o.length,r.length)>=.7)return!0;const d=o.filter(u=>u.length>3),h=r.filter(u=>u.length>3);return!!(h.length===1&&d.includes(h[0])||d.length===1&&h.includes(d[0]))}analyzeClickSequence(){if(!this.currentTask)return[];const s=this.currentTask.targets||[],t=this.currentTask.interactions||[],e=[],n=this.sessionData.mode;let o=0;for(let r=0;r<t.length;r++){const l=t[r];let g=null,d=null;n==="tabtabgo"?g=l.selectedIndex:d=l.cursorTraveledDistancePx;const h={timestamp:l.timestamp,tabsRequired:g,elementText:l.elementText,TabTabGoClick:l.TabTabGoClick,manualClick:l.manualClick,cursorTraveledDistancePx:d,timeSinceLastInteractionMs:l.timeSinceLastInteractionMs,expectedTarget:null,isError:!1,errorReason:null};if(o<s.length){const u=s[o];h.expectedTarget=u,this.matchesTarget(l.elementText,u)?(h.isError=!1,h.errorReason=null,o++):(h.isError=!0,h.errorReason="incorrect")}else h.isError=!0,h.errorReason="extra",h.expectedTarget=null;e.push(h)}for(;o<s.length;)e.push({timestamp:null,tabsRequired:null,elementText:null,TabTabGoClick:!1,manualClick:!1,cursorTraveledDistancePx:0,timeSinceLastInteractionMs:null,expectedTarget:s[o],isError:!0,errorReason:"absent"}),o++;return e}async logInteraction(s){if(!this.sessionActive||!this.currentTask){console.warn("No active task to log interaction");return}const t=Date.now(),e=this.lastInteractionTime?t-this.lastInteractionTime:0,n={timestamp:s.timestamp,selectedIndex:s.selectedIndex,manualClick:s.manualClick,TabTabGoClick:s.TabTabGoClick,elementText:s.elementText,cursorTraveledDistancePx:s.cursorTraveledDistancePx||0,timeSinceLastInteractionMs:e};this.currentTask.interactions.push(n),this.sessionData.totalInteractions++,s.manualClick&&this.sessionData.totalManualClicks++,s.TabTabGoClick&&this.sessionData.totalTabTabGoClicks++,this.lastInteractionTime=t,await chrome.storage.local.set({currentSession:this.sessionData,currentTask:this.currentTask}),await this.checkTaskCompletion()}async logSyncData(s){if(!this.sessionActive||!this.sessionData){console.warn("âš ï¸ Cannot log sync data - no active session");return}this.sessionData.syncData={timestamps:s.timestamps,intervals:s.intervals,totalDuration:s.totalDuration,loggedAt:Date.now()},await chrome.storage.local.set({currentSession:this.sessionData}),console.log("âœ… Sync data logged:",s)}async checkTaskCompletion(){if(!this.currentTask)return;const s=this.currentTask.targets||[];this.currentTask.interactions;const t=this.analyzeClickSequence();let e=0;for(const n of t)!n.isError&&n.timestamp!==null&&e++;e>=s.length&&await this.completeTask("completed")}async completeTask(s="completed"){if(!this.currentTask)return;const t=Date.now();this.currentTask.clickSequence=this.analyzeClickSequence();const e=this.currentTask.targets||[];let n=0,o=!1;for(const r of this.currentTask.clickSequence)r.isError&&(o=!0),!r.isError&&r.timestamp!==null&&n++;return this.currentTask.endTs=t,this.currentTask.taskDuration=t-this.currentTask.startTs,this.currentTask.endState=s,this.currentTask.finalTargetReached=n>=e.length,this.currentTask.mistakesMade=o,delete this.currentTask.interactions,this.sessionData.tasks.push(this.currentTask),this.currentTask=null,await chrome.storage.local.set({currentSession:this.sessionData,currentTask:null}),this.currentTaskIndex++,this.currentTaskIndex<this.TASKS.length?await this.startTask(this.currentTaskIndex):await this.endSession(),this.sessionData.tasks[this.sessionData.tasks.length-1]}async continueToNextTask(){this.waitingForTaskContinue=!1,this.currentTask&&await this.completeTask("skipped"),this.currentTaskIndex<this.TASKS.length?await this.startTask(this.currentTaskIndex):await this.endSession()}async endSession(){if(!this.sessionActive)return null;this.currentTask&&!this.waitingForTaskContinue&&await this.completeTask("ended_wrong"),this.sessionTimer&&(clearTimeout(this.sessionTimer),this.sessionTimer=null);const s=Date.now();this.sessionData.sessionEndTs=s,this.sessionData.sessionDuration=s-this.sessionData.sessionStartTs,this.sessionActive=!1,await chrome.storage.local.set({currentSession:null,currentTask:null,sessionActive:!1});const t=this.exportToJSON();this.downloadJSON(t),this.broadcastSessionState();const e={...this.sessionData};return this.sessionData=null,this.currentTaskIndex=0,e}exportToJSON(){if(!this.sessionData)return null;const s={participantId:this.sessionData.participantId,mode:this.sessionData.mode,sessionId:this.sessionData.sessionId,sessionStartTs:this.sessionData.sessionStartTs,sessionEndTs:this.sessionData.sessionEndTs,sessionDuration:this.sessionData.sessionDuration,sessionDate:this.sessionData.sessionDate,totalInteractions:this.sessionData.totalInteractions,totalManualClicks:this.sessionData.totalManualClicks,totalTabTabGoClicks:this.sessionData.totalTabTabGoClicks,totalTasks:this.sessionData.totalTasks,syncData:this.sessionData.syncData?{syncTimestamp1:this.sessionData.syncData.timestamps[0],syncTimestamp2:this.sessionData.syncData.timestamps[1],syncTimestamp3:this.sessionData.syncData.timestamps[2],syncInterval1to2:this.sessionData.syncData.intervals[0],syncInterval2to3:this.sessionData.syncData.intervals[1],syncTotalDuration:this.sessionData.syncData.totalDuration,syncLoggedAt:this.sessionData.syncData.loggedAt}:null,tasks:this.sessionData.tasks.map(t=>({taskId:t.taskId,targets:t.targets||[],startTs:t.startTs,endTs:t.endTs,taskDuration:t.taskDuration,endState:t.endState,finalTargetReached:t.finalTargetReached,mistakesMade:t.mistakesMade,interactions:t.clickSequence||[]}))};return JSON.stringify(s,null,2)}downloadJSON(s){if(!s)return;const t=new Date,e=t.toISOString().replace(/[:.]/g,"-").split("T")[0],n=t.toTimeString().split(" ")[0].replace(/:/g,"-"),o=`${this.sessionData.sessionId}_${this.sessionData.mode}_${e}_${n}.json`,r="data:application/json;base64,"+btoa(unescape(encodeURIComponent(s)));chrome.downloads.download({url:r,filename:o,saveAs:!0},l=>{chrome.runtime.lastError?console.error("Download error:",chrome.runtime.lastError):console.log("Session data downloaded:",l)})}getSessionInfo(){if(!this.sessionActive)return null;const s=Date.now()-this.sessionData.sessionStartTs,t=Math.max(0,this.SESSION_DURATION_MS-s);return{active:this.sessionActive,participantId:this.sessionData.participantId,mode:this.sessionData.mode,elapsed:s,remaining:t,totalInteractions:this.sessionData.totalInteractions,currentTask:this.currentTask?{taskNumber:this.currentTaskIndex+1,totalTasks:this.TASKS.length}:null}}async restoreSession(){const s=await chrome.storage.local.get(["currentSession","sessionActive","currentTask"]);if(s.sessionActive&&s.currentSession){this.sessionData=s.currentSession,this.sessionActive=!0,s.currentTask&&(this.currentTask=s.currentTask);const t=Date.now()-this.sessionData.sessionStartTs;if(t>=this.SESSION_DURATION_MS)await this.endSession();else{const e=this.SESSION_DURATION_MS-t;this.sessionTimer=setTimeout(()=>{this.endSession()},e)}}}broadcastSessionState(){chrome.tabs.query({},s=>{s.forEach(t=>{chrome.tabs.sendMessage(t.id,{action:"sessionStateChanged",sessionActive:this.sessionActive,mode:this.sessionActive?this.sessionData.mode:null}).catch(()=>{})})})}broadcastTaskInfo(){this.currentTask&&chrome.tabs.query({},s=>{s.forEach(t=>{chrome.tabs.sendMessage(t.id,{action:"taskStarted",task:{taskNumber:this.currentTaskIndex+1,totalTasks:this.TASKS.length}}).catch(()=>{})})})}broadcastTaskComplete(s){chrome.tabs.query({},t=>{t.forEach(e=>{chrome.tabs.sendMessage(e.id,{action:"taskComplete",nextTask:s?{taskNumber:this.currentTaskIndex+1,totalTasks:this.TASKS.length}:null}).catch(()=>{})})})}}const c=new f;let i=null;chrome.runtime.onStartup.addListener(async()=>{console.log("ðŸš€ Extension startup - restoring session"),await c.restoreSession();const a=await chrome.storage.local.get(["sessionTabId"]);a.sessionTabId&&(i=a.sessionTabId,console.log("ðŸ“Œ Restored session tab ID:",i))});chrome.runtime.onInstalled.addListener(async()=>{console.log("ðŸ“¦ Extension installed - restoring session"),await c.restoreSession()});chrome.runtime.onMessage.addListener((a,s,t)=>(console.log("ðŸ“© Background received message:",a.action,"from tab:",s.tab?.id),(async()=>{try{if(a.action==="startSession"){console.log("â–¶ï¸ Starting session:",a.participantId,a.sessionId,a.mode);const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(i=e?.id,!i)throw new Error("No active tab found to start session");console.log("ðŸ“Œ Session will run on tab:",i);const n=await c.startSession(a.participantId,a.sessionId,a.mode);await chrome.storage.local.set({sessionTabId:i}),console.log("âœ… Session started successfully:",n),t({success:!0,data:n}),setTimeout(async()=>{await D()},500)}else if(a.action==="syncComplete")console.log("ðŸ“Š Sync complete, data:",a.data),await c.logSyncData(a.data),setTimeout(async()=>{const e=await c.startTask(0)},500),t({success:!0});else if(a.action==="startNextTask"){const e=a.taskIndex,n=await c.startTask(e);t({success:!0,task:n})}else if(a.action==="completeTask"){console.log("âœ… Completing task with endState:",a.endState),await c.completeTask(a.endState);const e=c.getSessionInfo(),n=e.currentSession.tasks.length,o=e.TASKS.length;console.log(`ðŸ“Š Task progress: ${n}/${o}`),await w(n,o,a.endState),n<o?setTimeout(async()=>{console.log("ðŸ”„ Auto-starting next task..."),await c.startTask(n)},2500):setTimeout(async()=>{console.log("ðŸ All tasks complete, ending session..."),await c.endSession(),i=null,await chrome.storage.local.remove(["sessionTabId"])},3e3),t({success:!0})}else if(a.action==="continueNextTask")console.log("âž¡ï¸ Continuing to next task"),await c.continueToNextTask(),t({success:!0});else if(a.action==="endSession"){console.log("â¹ï¸ Ending session");const e=await c.endSession();console.log("âœ… Session ended, interactions:",e?.totalInteractions||0),i=null,await chrome.storage.local.remove(["sessionTabId"]),t({success:!0,data:e})}else if(a.action==="getSessionInfo"){console.log("â„¹ï¸ Getting session info");const e=c.getSessionInfo();console.log("ðŸ“Š Session info:",e),t({success:!0,data:e})}else a.action==="logInteraction"?(console.log("ðŸ“ Logging interaction:",a.data),await c.logInteraction(a.data),console.log("âœ… Interaction logged, total now:",c.sessionData?.totalInteractions),t({success:!0})):(console.warn("âš ï¸ Unknown action:",a.action),t({success:!1,error:"Unknown action"}))}catch(e){console.error("âŒ Background script error:",e),t({success:!1,error:e.message})}})(),!0));async function D(){try{if(!i){console.error("âŒ No session tab ID - cannot show sync screen");return}console.log("ðŸ“Š Showing sync screen on session tab:",i);try{await chrome.tabs.sendMessage(i,{action:"showSync"}),console.log("âœ… Sync screen message sent successfully")}catch(a){console.error("âŒ Failed to send sync message:",a),console.error("Content script may not be loaded on tab:",i)}}catch(a){console.error("âŒ Error showing sync screen:",a)}}async function w(a,s,t){try{if(!i){console.error("âŒ No session tab ID - cannot show task interstitial");return}console.log(`ðŸ“‹ Showing task interstitial on session tab ${i}: ${a}/${s} (${t})`);try{const e=await chrome.tabs.sendMessage(i,{action:"showTaskInterstitial",taskNumber:a,totalTasks:s,status:t});console.log("âœ… Task interstitial message sent, response:",e)}catch(e){console.error("âŒ Failed to send task interstitial message:",e),console.error("Content script may not be loaded on session tab:",i),console.error("Error details:",e.message)}}catch(e){console.error("âŒ Error showing task interstitial:",e)}}chrome.tabs.onUpdated.addListener(async(a,s,t)=>{s.status==="complete"&&(await chrome.storage.local.get(["sessionActive"])).sessionActive&&(console.log("ðŸŒ Tab loaded during active session:",t.url),a===i&&console.log("ðŸ“ Session tab navigated to:",t.url))});chrome.tabs.onRemoved.addListener(async a=>{a===i&&(console.warn("âš ï¸ Session tab was closed!"),i=null,await chrome.storage.local.remove(["sessionTabId"]))});let T=null;function k(){T||(console.log("ðŸ’š Starting keep-alive"),T=setInterval(async()=>{await c.restoreSession()},3e4))}function p(){T&&(console.log("ðŸ’” Stopping keep-alive"),clearInterval(T),T=null)}k();chrome.storage.onChanged.addListener((a,s)=>{s==="local"&&a.sessionActive&&(console.log("ðŸ”„ Session state changed:",a.sessionActive.newValue),a.sessionActive.newValue?k():p())});
